<div class="page stock-page">
    <h1 class="page__title">Modifier le pneu</h1>
    <div class="page__wrapper">
        <div class="stock-page__content">
            <aside class="stock-page__form">
                <?php if (\App\Core\Access::hasOneRole(['super_admin', 'admin', 'secretary', 'user'])) { ?>
                    <form method="POST" action="index.php" class="form">
                        <?= $this->getCsrfField(); ?>
                        <input type="hidden" name="route" class="form__input" value="stock-update">
                        <input type="hidden" name="product_id" class="form__input" value="<?= $tire['id'] ?>">
                        <?php if (!empty($_GET['brand'])) { ?>
                            <input type="hidden" name="search_brand" class="form__input" value="<?= htmlspecialchars($_GET['brand']) ?>">
                        <?php } ?>
                        <?php if (!empty($_GET['width'])) { ?>
                            <input type="hidden" name="search_width" class="form__input" value="<?= htmlspecialchars($_GET['width']) ?>">
                        <?php } ?>
                        <?php if (!empty($_GET['height'])) { ?>
                            <input type="hidden" name="search_height" class="form__input" value="<?= htmlspecialchars($_GET['height']) ?>">
                        <?php } ?>
                        <?php if (!empty($_GET['diameter'])) { ?>
                            <input type="hidden" name="search_diameter" class="form__input" value="<?= htmlspecialchars($_GET['diameter']) ?>">
                        <?php } ?>
                        <?php if (!empty($_GET['load_index'])) { ?>
                            <input type="hidden" name="search_load_index" class="form__input" value="<?= htmlspecialchars($_GET['load_index']) ?>">
                        <?php } ?>
                        <?php if (!empty($_GET['speed_index'])) { ?>
                            <input type="hidden" name="search_speed_index" class="form__input" value="<?= htmlspecialchars($_GET['speed_index']) ?>">
                        <?php } ?>
                        <?php
                        if (!empty($_GET['season'])) {
                            foreach ($_GET['season'] as $season) {
                        ?>
                            <input type="hidden" name="search_season[]" class="form__input" value="<?= htmlspecialchars($season) ?>">
                        <?php }} ?>
                        <?php
                        if (!empty($_GET['quality'])) {
                            foreach ($_GET['quality'] as $quality) {
                        ?>
                            <input type="hidden" name="search_quality[]" class="form__input" value="<?= htmlspecialchars($quality) ?>">
                        <?php }} ?>
                        <?php $readonly = $isInvoiced ? 'readonly' : ''; ?>
                        <?php $disabled = $isInvoiced ? 'disabled' : ''; ?>
                        <fieldset class="form__fieldset">
                            <legend class="sr-only">Renseignements du pneu</legend>
                            <div class="form__grid">
                                <div class="form__group">
                                    <label class="form__label" for="brand">Marque</label>
                                    <select class="form__select" name="brand" id="brand" <?= $disabled ?>>
                                        <?php foreach($brands as $brand) { ?>
                                            <option value="<?= htmlspecialchars($brand, ENT_QUOTES) ?>" <?php if (trim(strtoupper($tire['brand'])) === trim(strtoupper($brand))) echo 'selected'; ?>>
                                                <?= htmlspecialchars($brand, ENT_QUOTES) ?>
                                            </option>
                                        <?php } ?>
                                    </select>
                                </div>
                                <div class="form__group">
                                    <label class="form__label" for="width">Largeur</label>
                                    <input type="text" id="width" name="width" class="form__input" value="<?= htmlspecialchars($tire['width'], ENT_QUOTES) ?>" placeholder="Largeur" <?= $disabled ?>>
                                </div>
                                <div class="form__group">
                                    <label class="form__label" for="height">Hauteur</label>
                                    <input type="text" id="height" name="height" class="form__input" value="<?= htmlspecialchars($tire['height'], ENT_QUOTES) ?>" placeholder="Hauteur" <?= $disabled ?>>
                                </div>
                                <div class="form__group">
                                    <label class="form__label" for="diameter">Diamètre</label>
                                    <input type="text" id="diameter" name="diameter" class="form__input" value="<?= htmlspecialchars($tire['diameter'], ENT_QUOTES) ?>" placeholder="Diamètre" <?= $disabled ?>>
                                </div>
                                <div class="form__group">
                                    <label class="form__label" for="load_index">Charge</label>
                                    <input type="text" id="load_index" name="load_index" class="form__input" value="<?= htmlspecialchars($tire['load_index'], ENT_QUOTES) ?>" placeholder="Charge" <?= $disabled ?>>
                                </div>
                                <div class="form__group">
                                    <label class="form__label" for="speed_index">Vitesse</label>
                                    <input type="text" id="speed_index" name="speed_index" class="form__input" value="<?= htmlspecialchars($tire['speed_index'], ENT_QUOTES) ?>" placeholder="Vitesse" <?= $disabled ?>>
                                </div>
                                <div class="form__group">
                                    <label class="form__label" for="dot">DOT</label>
                                    <input type="text" id="dot" name="dot" class="form__input" value="<?= htmlspecialchars($tire['dot'] ?? '', ENT_QUOTES) ?>" placeholder="DOT" <?= $disabled ?>>
                                </div>
                                <div class="form__group">
                                    <label class="form__label" for="quantity_available">Quantité</label>
                                    <input type="text" id="quantity_available" name="quantity_available" class="form__input" value="<?= htmlspecialchars($tire['quantity_available'], ENT_QUOTES) ?>" placeholder="Quantité">
                                    <input type="hidden" id="original_quantity" class="form__input" value="<?= htmlspecialchars($tire['quantity_available'], ENT_QUOTES) ?>">
                                </div>
                                <div id="movement_reason_wrapper" class="form__group is-hidden">
                                    <label class="form__label" for="movement_reason">Motif de la modification</label>
                                    <select class="form__select" name="movement_reason" id="movement_reason">
                                        <option value="" disabled selected hidden>Choisir dans la liste</option>
                                        <?php foreach ($reasons as $reason) { ?>
                                                        <option value="<?= htmlspecialchars($reason, ENT_QUOTES) ?>"><?= htmlspecialchars(ucfirst($reason), ENT_QUOTES) ?></option>
                                        <?php } ?>
                                    </select>
                                </div>
                                <div id="reason_detail_wrapper" class="form__group is-hidden">
                                    <label class="form__label" for="reason_detail">Détail du motif</label>
                                    <textarea class="form__textarea" name="reason_detail" id="reason_detail" placeholder="Précisez ici..."></textarea>
                                </div>
                                <div class="form__group">
                                    <label class="form__label" for="unit_price_excluding_tax">P.U. H.T.</label>
                                    <input type="text" id="unit_price_excluding_tax" name="unit_price_excluding_tax" class="form__input" value="<?= htmlspecialchars($tire['unit_price_excluding_tax'], ENT_QUOTES) ?>" placeholder="P.U. H.T.">
                                </div>
                            </div>
                            <div class="form__group">
                                <label class="form__label" for="season">Saison</label>
                                <select class="form__select" name="season" id="season" <?= $disabled ?> required>
                                    <option value="">Choisir une saison</option>
                                    <option value="ETE" <?= ($tire['season'] === 'ETE') ? 'selected' : '' ?>>Été</option>
                                    <option value="4S" <?= ($tire['season'] === '4S') ? 'selected' : '' ?>>4 Saisons</option>
                                    <option value="HIVER" <?= ($tire['season'] === 'HIVER') ? 'selected' : '' ?>>Hiver</option>
                                </select>
                            </div>

                            <div class="form__group">
                                <label class="form__label" for="quality">État</label>
                                <select class="form__select" name="quality" id="quality" <?= $disabled ?> required>
                                    <option value="">Choisir un état</option>
                                    <option value="NEUF" <?= ($tire['quality'] === 'NEUF') ? 'selected' : '' ?>>Neuf</option>
                                    <option value="TB" <?= ($tire['quality'] === 'TB') ? 'selected' : '' ?>>Très bon</option>
                                    <option value="MOY" <?= ($tire['quality'] === 'MOY') ? 'selected' : '' ?>>Moyen</option>
                                </select>
                            </div>

                            <div class="form__actions">
                                <button type="submit" class="btn btn--dark">Valider</button>

                                <?php
                                $backUrl = 'index.php?route=stock-search';
                                if (!empty($_GET['brand'])) { $backUrl .= '&brand=' . urlencode($_GET['brand']); }
                                if (!empty($_GET['width'])) { $backUrl .= '&width=' . urlencode($_GET['width']); }
                                if (!empty($_GET['height'])) { $backUrl .= '&height=' . urlencode($_GET['height']); }
                                if (!empty($_GET['diameter'])) { $backUrl .= '&diameter=' . urlencode($_GET['diameter']); }
                                if (!empty($_GET['load_index'])) { $backUrl .= '&load_index=' . urlencode($_GET['load_index']); }
                                if (!empty($_GET['speed_index'])) { $backUrl .= '&speed_index=' . urlencode($_GET['speed_index']); }
                                if (!empty($_GET['season'])) {
                                    foreach($_GET['season'] as $season) {
                                        $backUrl .= '&season[]=' . urlencode($season);
                                    }
                                }
                                if (!empty($_GET['quality'])) {
                                    foreach($_GET['quality'] as $quality) {
                                        $backUrl .= '&quality[]=' . urlencode($quality);
                                    }
                                }
                                ?>

                                <a href="<?= $backUrl ?>" class="btn btn--dark">Annuler</a>

                            </div>
                        </fieldset>
                    </form>
                <?php } ?>
            </aside>
            <div class="stock-page__table">
                <div class="stock-page__table-wrapper">
                    <section class="stock-page__table-content">
                        <h2 class="sr-only">Liste des résultats de la recherche de stock</h2>
                        <table class="table">
                            <thead class="table__thead">
                                <tr class="table__tr">
                                    <th class="table__th"data-label = "Marque">Marque</th>
                                    <th class="table__th"data-label = "Taille commerciale">Taille commerciale</th>
                                    <th class="table__th"data-label = "Charge/Vitesse">Charge / Vitesse</th>
                                    <th class="table__th"data-label = "Saison">Saison</th>
                                    <th class="table__th"data-label="DOT">DOT</th>
                                    <th class="table__th"data-label = "État">État</th>
                                    <th class="table__th"data-label = "Quantité">Quantité</th>
                                    <th class="table__th"data-label = "Prix unitaire H.T.">Prix unitaire H.T.</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="table__tr" id="preview-line">
                                    <td class="table__td" id="preview-brand"><?= htmlspecialchars($tire['brand'], ENT_QUOTES) ?></td>
                                    <td class="table__td" id="preview-size"><?= htmlspecialchars($tire['width'], ENT_QUOTES) ?>/<?= htmlspecialchars($tire['height'], ENT_QUOTES) ?>/<?= htmlspecialchars($tire['diameter'], ENT_QUOTES) ?></td>
                                    <td class="table__td" id="preview-load-speed"><?= htmlspecialchars($tire['load_index'], ENT_QUOTES) ?><?= htmlspecialchars($tire['speed_index'], ENT_QUOTES) ?></td>
                                    <td class="table__td" id="preview-season"><?= htmlspecialchars($tire['season'], ENT_QUOTES) ?></td>
                                    <td class="table__td" id="preview-dot"><?=  htmlspecialchars($tire['dot'], ENT_QUOTES) ?></td>
                                    <td class="table__td" id="preview-quality"><?= htmlspecialchars($tire['quality'], ENT_QUOTES) ?></td>
                                    <td class="table__td" id="preview-quantity"><?= htmlspecialchars($tire['quantity_available'], ENT_QUOTES) ?></td>
                                    <td class="table__td" id="preview-price"><?= htmlspecialchars($tire['unit_price_excluding_tax'], ENT_QUOTES) ?> €</td>
                                </tr>
                            </tbody>
                        </table>
                    </section>
                </div>
            </div>
        </div>
    </div>
</div>